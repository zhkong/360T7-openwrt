name: 360T7 OpenWRT ImageBuilder Build

on:
  schedule:
    # 每6小时检查一次 OpenWrt 是否有新 release
    - cron: '0 */6 * * *'
  push:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrt 版本/标签 (例如: 24.10.5, 留空则使用最新 release)'
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-24.04
    # 对于 schedule 和 workflow_dispatch 事件，不检查 sender
    if: |
      github.event_name == 'schedule' || 
      github.event_name == 'workflow_dispatch' || 
      github.event.repository.owner.id == github.event.sender.id

    steps:
    - name: Show system
      run: |
        echo -e "Total CPU cores\t: $(nproc)"
        cat /proc/cpuinfo | grep 'model name'
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 1024
        temp-reserve-mb: 512
        root-reserve-mb: 4608
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
    - name: Checkout
      uses: actions/checkout@main
    - name: Install dependencies
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -y -qq install curl tar zstd git make
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        df -h
    - name: Check OpenWrt Release
      id: check_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # 检查是否手动指定了版本（仅在 workflow_dispatch 事件中可用）
        FORCE_BUILD=false
        if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.openwrt_version }}" ]; then
          # 使用手动指定的版本，强制构建
          OPENWRT_VERSION="${{ inputs.openwrt_version }}"
          OPENWRT_TAG="${{ inputs.openwrt_version }}"
          FORCE_BUILD=true
          echo "使用手动指定的 OpenWrt 版本: $OPENWRT_VERSION，强制构建"
        else
          # 获取上游 OpenWrt 最新的 release 标签
          echo "正在检查 OpenWrt 最新 release..."
          OPENWRT_VERSION=$(curl -s https://api.github.com/repos/openwrt/openwrt/releases/latest | grep '"tag_name":' | sed -E 's/.*"v?([^"]+)".*/\1/' | head -n 1)
          if [ -z "$OPENWRT_VERSION" ]; then
            # 如果没有 release，尝试从下载页面获取
            OPENWRT_VERSION=$(curl -s https://downloads.openwrt.org/releases/ | grep -oP 'href="\K[0-9]+\.[0-9]+\.[0-9]+(?=/")' | sort -V | tail -n 1)
          fi
          if [ -z "$OPENWRT_VERSION" ]; then
            # 如果还是获取不到，使用默认版本
            OPENWRT_VERSION="24.10.5"
            echo "未找到最新版本，使用默认版本: $OPENWRT_VERSION"
          fi
          OPENWRT_TAG="$OPENWRT_VERSION"
        fi
        
        # 获取版本号的短格式（用于命名）
        if [[ "$OPENWRT_VERSION" == v* ]]; then
          OPENWRT_VERSION_SHORT="${OPENWRT_VERSION#v}"
        else
          OPENWRT_VERSION_SHORT="$OPENWRT_VERSION"
        fi
        
        echo "上游 OpenWrt 版本: $OPENWRT_VERSION_SHORT"
        
        # 获取当前仓库的最新 release 版本（用于比较）
        NEED_BUILD=true
        if [ "$FORCE_BUILD" != "true" ]; then
          echo "正在检查当前仓库的最新 release..."
          LATEST_RELEASE_JSON=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest")
          
          if [ "$LATEST_RELEASE_JSON" != "null" ] && [ -n "$LATEST_RELEASE_JSON" ]; then
            # 提取 release 标签名（格式: openwrt-{version}-{timestamp}）
            LATEST_RELEASE_TAG_FULL=$(echo "$LATEST_RELEASE_JSON" | grep '"tag_name":' | sed -E 's/.*"tag_name":\s*"([^"]+)".*/\1/' | head -n 1)
            
            if [ -n "$LATEST_RELEASE_TAG_FULL" ]; then
              # 从标签中提取 OpenWrt 版本号（格式: openwrt-24.10.5-20241201-120000）
              # 提取 openwrt- 之后的第一个版本号部分
              LATEST_RELEASE_TAG=$(echo "$LATEST_RELEASE_TAG_FULL" | sed -E 's/^openwrt-([0-9]+\.[0-9]+\.[0-9]+)-.*/\1/')
              
              if [ -n "$LATEST_RELEASE_TAG" ] && [ "$LATEST_RELEASE_TAG" != "$LATEST_RELEASE_TAG_FULL" ]; then
                echo "当前仓库最新 release 标签: $LATEST_RELEASE_TAG_FULL"
                echo "当前仓库最新 release 中的 OpenWrt 版本: $LATEST_RELEASE_TAG"
                
                # 使用 sort -V 进行版本比较
                # sort -V 按版本号排序，最新的在最后
                SORTED_VERSIONS=$(printf "%s\n%s" "$LATEST_RELEASE_TAG" "$OPENWRT_VERSION_SHORT" | sort -V)
                HIGHEST_VERSION=$(echo "$SORTED_VERSIONS" | tail -n 1)
                
                if [ "$HIGHEST_VERSION" = "$LATEST_RELEASE_TAG" ]; then
                  # 当前版本 >= 上游版本
                  if [ "$LATEST_RELEASE_TAG" = "$OPENWRT_VERSION_SHORT" ]; then
                    NEED_BUILD=false
                    echo "当前版本 ($LATEST_RELEASE_TAG) == 上游版本 ($OPENWRT_VERSION_SHORT)，跳过构建"
                  else
                    NEED_BUILD=false
                    echo "当前版本 ($LATEST_RELEASE_TAG) > 上游版本 ($OPENWRT_VERSION_SHORT)，跳过构建"
                  fi
                else
                  # 当前版本 < 上游版本
                  echo "当前版本 ($LATEST_RELEASE_TAG) < 上游版本 ($OPENWRT_VERSION_SHORT)，需要构建"
                fi
              else
                echo "无法从 release 标签 ($LATEST_RELEASE_TAG_FULL) 中提取版本号，将进行构建"
              fi
            else
              echo "未找到有效的 release 标签，将进行构建"
            fi
          else
            echo "未找到当前仓库的 release，将进行首次构建"
          fi
        fi
        
        # 设置环境变量和输出
        echo "OPENWRT_VERSION=$OPENWRT_VERSION" >> $GITHUB_ENV
        echo "OPENWRT_TAG=$OPENWRT_TAG" >> $GITHUB_ENV
        echo "OPENWRT_VERSION_SHORT=$OPENWRT_VERSION_SHORT" >> $GITHUB_ENV
        echo "need_build=$NEED_BUILD" >> $GITHUB_OUTPUT
        
        # 保存到文件，供 build-image.sh 使用
        echo "$OPENWRT_TAG" > /tmp/openwrt_tag.txt
        echo "检测到 OpenWrt 版本: $OPENWRT_VERSION"
        echo "版本短格式: $OPENWRT_VERSION_SHORT"
        echo "是否需要构建: $NEED_BUILD"
    - name: Skip build notice
      if: steps.check_release.outputs.need_build != 'true'
      run: |
        echo "::notice title=跳过构建::当前仓库版本已是最新或更新，无需构建"
        echo "上游 OpenWrt 版本: ${{ env.OPENWRT_VERSION_SHORT }}"
    - name: Build firmware with ImageBuilder
      if: steps.check_release.outputs.need_build == 'true'
      run: |
        bash ./scripts/build-image.sh
    - name: Get build info
      if: steps.check_release.outputs.need_build == 'true'
      id: build_info
      run: |
        # 获取构建时间戳
        BUILD_TIME=$(date +%Y%m%d-%H%M%S)
        echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT
        
        # 获取固件文件信息
        if [ -d "./output" ] && [ -n "$(ls -A ./output 2>/dev/null)" ]; then
          FIRMWARE_FILE=$(ls -1 ./output/*.bin ./output/*.img* 2>/dev/null | head -n 1)
          if [ -n "$FIRMWARE_FILE" ]; then
            FIRMWARE_NAME=$(basename "$FIRMWARE_FILE")
            FIRMWARE_SIZE=$(du -h "$FIRMWARE_FILE" | cut -f1)
            echo "firmware_name=${FIRMWARE_NAME}" >> $GITHUB_OUTPUT
            echo "firmware_size=${FIRMWARE_SIZE}" >> $GITHUB_OUTPUT
            echo "固件文件: $FIRMWARE_NAME ($FIRMWARE_SIZE)"
          fi
        fi
    - name: Print Disk Space After
      if: steps.check_release.outputs.need_build == 'true'
      run: df -h
    - name: Organize files
      if: steps.check_release.outputs.need_build == 'true'
      id: organize
      env:
        OPENWRT_VERSION_SHORT: ${{ env.OPENWRT_VERSION_SHORT }}
      run: |
        rm -rf ./artifact/
        mkdir -p ./artifact/
        if [ -d "./output" ] && [ -n "$(ls -A ./output 2>/dev/null)" ]; then
          cd ./output/
          # 重命名文件，去掉 openwrt-{version}-custom-mediatek-filogic- 前缀
          prefix="openwrt-${OPENWRT_VERSION_SHORT}-custom-mediatek-filogic-"
          for file in *; do
            if [ -f "$file" ]; then
              # 去掉前缀
              if [[ "$file" == "${prefix}"* ]]; then
                new_name="${file#${prefix}}"
                mv -v "$file" "../artifact/$new_name"
              else
                cp -v "$file" "../artifact/"
              fi
            fi
          done
          cd ..
        fi
        cd ./artifact/
        # 如果存在 sha256sums 文件，更新其中的文件名引用（去掉前缀）
        if [ -f "sha256sums" ]; then
          echo "更新 sha256sums 文件中的文件名引用..."
          prefix="openwrt-${OPENWRT_VERSION_SHORT}-custom-mediatek-filogic-"
          # 去掉文件名中的前缀
          sed -i "s|${prefix}||g" sha256sums
          echo "已更新 sha256sums 文件："
          cat sha256sums
        fi
        echo "已包含的文件："
        ls -Ahl
    - name: Upload artifact
      if: steps.check_release.outputs.need_build == 'true'
      uses: actions/upload-artifact@main
      with:
        name: OpenWRT-ImageBuilder-${{ env.OPENWRT_VERSION_SHORT }}-${{ steps.build_info.outputs.build_time }}
        path: ./artifact/

    - name: Create release
      if: steps.check_release.outputs.need_build == 'true'
      id: create_release
      uses: ncipollo/release-action@v1.14.0
      with:
        name: openwrt ${{ env.OPENWRT_VERSION_SHORT }}
        allowUpdates: true
        tag: openwrt-${{ env.OPENWRT_VERSION_SHORT }}-${{ steps.build_info.outputs.build_time }}
        replacesArtifacts: true
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: ./artifact/*
